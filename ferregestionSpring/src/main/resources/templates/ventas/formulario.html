<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Nueva Venta - FerreGesti√≥n')"></head>
<style>
    #sugerenciasClientes {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    #sugerenciasClientes .list-group-item {
        border-left: none;
        border-right: none;
        cursor: pointer;
    }

    #sugerenciasClientes .list-group-item:first-child {
        border-top: none;
    }

    #sugerenciasClientes .list-group-item:last-child {
        border-bottom: none;
    }

    #sugerenciasClientes .list-group-item:hover {
        background-color: #f8f9fa;
    }
</style>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">Inicio</a></li>
            <li class="breadcrumb-item"><a th:href="@{/web/ventas}">Ventas</a></li>
            <li class="breadcrumb-item active">Nueva Venta</li>
        </ol>
    </nav>

    <!-- T√≠tulo -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-cart-plus"></i> Nueva Venta</h1>
        </div>
    </div>

    <!-- Mensaje de error -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Formulario -->
    <form th:action="@{/web/ventas/guardar}" method="post" onsubmit="return validarFormulario()">

        <div class="row">
            <!-- Columna izquierda: Datos generales -->
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informaci√≥n General</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cliente con b√∫squeda -->
                        <div class="mb-3">
                            <label for="buscarCliente" class="form-label">
                                Cliente <span class="text-danger">*</span>
                            </label>

                            <div style="position: relative;">
                                <input type="text"
                                       class="form-control"
                                       id="buscarCliente"
                                       placeholder="Buscar por nombre o c√©dula..."
                                       autocomplete="off">
                                <input type="hidden" id="cedula" name="cedula" required>

                                <!-- Lista de sugerencias -->
                                <div id="sugerenciasClientes"
                                     class="list-group"
                                     style="position: absolute;
                                            z-index: 1000;
                                            max-height: 300px;
                                            overflow-y: auto;
                                            width: 100%;
                                            display: none;
                                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                            margin-top: 2px;">
                                </div>
                            </div>

                            <small class="text-muted">
                                <a th:href="@{/web/clientes/nuevo}" target="_blank">
                                    <i class="bi bi-plus-circle"></i> Crear nuevo cliente
                                </a>
                            </small>

                            <div id="clienteSeleccionado" class="mt-2" style="display: none;">
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle"></i>
                                    <strong>Cliente:</strong>
                                    <span id="nombreClienteSeleccionado"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Fecha -->
                        <div class="mb-3">
                            <label for="fecha" class="form-label">
                                Fecha <span class="text-danger">*</span>
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="fecha"
                                   name="fecha"
                                   th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"
                                   required>
                        </div>

                        <!-- Tipo de Pago (BOTONES) -->
                        <div class="mb-3">
                            <label class="form-label">
                                Tipo de Pago <span class="text-danger">*</span>
                            </label>
                            <input type="hidden" id="tipoPago" name="tipoPago" required>

                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-success btn-pago" onclick="seleccionarPago('EFECTIVO', this)">
                                    <i class="bi bi-cash-coin"></i> Efectivo
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-pago" onclick="seleccionarPago('TARJETA', this)">
                                    <i class="bi bi-credit-card"></i> Tarjeta
                                </button>
                                <button type="button" class="btn btn-outline-info btn-pago" onclick="seleccionarPago('TRANSFERENCIA', this)">
                                    <i class="bi bi-arrow-left-right"></i> Transferencia
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-pago" onclick="seleccionarPago('CREDITO', this)">
                                    <i class="bi bi-clock-history"></i> Cr√©dito
                                </button>
                            </div>
                        </div>

                        <!-- Total (solo lectura) -->
                        <div class="mb-3">
                            <label class="form-label">Total</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text"
                                       class="form-control bg-light"
                                       id="totalVentaDisplay"
                                       value="0"
                                       readonly>
                            </div>
                            <input type="hidden" id="totalHidden" name="total" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Productos -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-box"></i> Agregar Productos</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Producto -->
                            <div class="col-md-5 mb-3">
                                <label for="productoId" class="form-label">Producto</label>
                                <select class="form-select" id="productoId" onchange="actualizarPrecio()">
                                    <option value="">Seleccione...</option>
                                    <option th:each="producto : ${productos}"
                                            th:value="${producto.idProducto}"
                                            th:text="${producto.descripcion}"
                                            th:attr="data-precio=${producto.precioVenta}, data-stock=${producto.stock}">
                                        Producto
                                    </option>
                                </select>
                            </div>

                            <!-- Cantidad -->
                            <div class="col-md-2 mb-3">
                                <label for="cantidad" class="form-label">Cantidad</label>
                                <input type="number"
                                       class="form-control"
                                       id="cantidad"
                                       min="1"
                                       value="1">
                            </div>

                            <!-- Precio -->
                            <div class="col-md-3 mb-3">
                                <label for="precio" class="form-label">Precio Unit.</label>
                                <input type="number"
                                       class="form-control"
                                       id="precio"
                                       step="0.01"
                                       readonly>
                            </div>

                            <!-- Bot√≥n agregar -->
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="button"
                                        class="btn btn-success w-100"
                                        onclick="agregarDetalle()">
                                    <i class="bi bi-plus-circle"></i> Agregar
                                </button>
                            </div>
                        </div>

                        <!-- Indicador de stock -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert alert-info mb-0" style="display: inline-block;">
                                    <i class="bi bi-box"></i>
                                    <strong>Stock disponible:</strong>
                                    <span id="stockDisponible">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de detalles -->
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody id="detallesTabla">
                                <!-- Los detalles se agregan din√°micamente aqu√≠ -->
                                </tbody>
                            </table>
                        </div>

                        <div id="mensajeVacio" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i>
                            <p>No hay productos agregados</p>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="row mt-4">
                    <div class="col">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-save"></i> Guardar Venta
                        </button>
                        <a th:href="@{/web/ventas}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div th:replace="fragments/footer :: footer"></div>
<div th:replace="fragments/footer :: scripts"></div>

<script>
    let detalleIndex = 0;
    let clientes = [];
    let clienteSeleccionado = null;
    let productosAgregados = {};

    // ========== CARGAR CLIENTES AL INICIAR ==========
window.addEventListener('DOMContentLoaded', async function() {
    console.log('=== INICIANDO CARGA DE CLIENTES ===');

    // M√âTODO 1: API
    try {
        console.log('Intentando desde /api/clientes...');
        const response = await fetch('/api/clientes');
        console.log('Status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Respuesta completa:', data);

            // ‚úÖ EXTRAER EL ARRAY DEL OBJETO PAGINADO
            if (Array.isArray(data)) {
                // Si es array directo
                clientes = data;
            } else if (data.content && Array.isArray(data.content)) {
                // Si es respuesta paginada (Spring Data)
                clientes = data.content;
            } else {
                // Si no se encuentra array
                console.error('Formato inesperado:', data);
                clientes = [];
            }

            console.log('‚úÖ Clientes desde API:', clientes);
        } else {
            throw new Error('Status ' + response.status);
        }
    } catch (error) {
        console.log('‚ùå Error API:', error);

        // M√âTODO 2: JSON del modelo
        try {
            const clientesJsonStr = /*[[${clientesJson}]]*/ '[]';
            console.log('JSON del modelo (primeros 200 chars):', clientesJsonStr.substring(0, 200));

            const data = JSON.parse(clientesJsonStr);

            // ‚úÖ EXTRAER EL ARRAY
            if (Array.isArray(data)) {
                clientes = data;
            } else if (data.content && Array.isArray(data.content)) {
                clientes = data.content;
            } else {
                clientes = [];
            }

            console.log('‚úÖ Clientes desde modelo:', clientes);
        } catch (e) {
            console.error('‚ùå Error parseando JSON:', e);
            clientes = [];
        }
    }

    console.log('=== CLIENTES FINALES ===');
    console.log('Total:', clientes.length);
    console.log('Lista:', clientes);

    // Hacer clientes global para debug
    window.clientesGlobal = clientes;

    const tabla = document.getElementById('detallesTabla');
    if (tabla && tabla.rows.length === 0) {
        document.getElementById('mensajeVacio').style.display = 'block';
    }
});

    // ========== B√öSQUEDA DE CLIENTES ==========
    document.getElementById('buscarCliente')?.addEventListener('input', function(e) {
        console.log('=== B√öSQUEDA ACTIVADA ===');
        const termino = e.target.value.toLowerCase().trim();
        const sugerencias = document.getElementById('sugerenciasClientes');

        console.log('üîç Buscando:', termino);
        console.log('üìã Total clientes:', clientes.length);

        if (termino.length < 2) {
            console.log('T√©rmino muy corto');
            sugerencias.style.display = 'none';
            return;
        }

        // Filtrar clientes
        const resultados = clientes.filter(cliente => {
            const nombreMatch = cliente.nombre.toLowerCase().includes(termino);
            const cedulaMatch = cliente.cedula.toString().includes(termino);
            return nombreMatch || cedulaMatch;
        });

        console.log('‚úÖ Resultados encontrados:', resultados.length);
        console.log('Resultados:', resultados);

        if (resultados.length === 0) {
            sugerencias.innerHTML = '<div class="list-group-item">No se encontraron clientes</div>';
            sugerencias.style.display = 'block';
            return;
        }

        // Mostrar sugerencias
        sugerencias.innerHTML = '';
        resultados.slice(0, 5).forEach(cliente => {
            const item = document.createElement('a');
            item.className = 'list-group-item list-group-item-action';
            item.href = '#';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <strong>${cliente.nombre}</strong><br>
                <small class="text-muted">C√©dula: ${cliente.cedula}</small>
            `;
            item.onclick = function(e) {
                e.preventDefault();
                seleccionarCliente(cliente);
            };
            sugerencias.appendChild(item);
        });

        sugerencias.style.display = 'block';
        console.log('‚úÖ Sugerencias mostradas');
    });

    function seleccionarCliente(cliente) {
        console.log('‚úÖ Cliente seleccionado:', cliente);
        clienteSeleccionado = cliente;
        document.getElementById('cedula').value = cliente.cedula;
        document.getElementById('buscarCliente').value = '';
        document.getElementById('sugerenciasClientes').style.display = 'none';

        document.getElementById('nombreClienteSeleccionado').textContent =
            `${cliente.nombre} - ${cliente.cedula}`;
        document.getElementById('clienteSeleccionado').style.display = 'block';
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('#buscarCliente') && !e.target.closest('#sugerenciasClientes')) {
            document.getElementById('sugerenciasClientes').style.display = 'none';
        }
    });

    // ========== TIPO DE PAGO ==========
    function seleccionarPago(tipo, boton) {
        document.querySelectorAll('.btn-pago').forEach(btn => {
            btn.classList.remove('active');
            btn.classList.add('btn-outline-success', 'btn-outline-primary', 'btn-outline-info', 'btn-outline-warning');
            btn.classList.remove('btn-success', 'btn-primary', 'btn-info', 'btn-warning');
        });

        boton.classList.add('active');
        boton.classList.remove('btn-outline-success', 'btn-outline-primary', 'btn-outline-info', 'btn-outline-warning');

        if (tipo === 'EFECTIVO') {
            boton.classList.add('btn-success');
        } else if (tipo === 'TARJETA') {
            boton.classList.add('btn-primary');
        } else if (tipo === 'TRANSFERENCIA') {
            boton.classList.add('btn-info');
        } else if (tipo === 'CREDITO') {
            boton.classList.add('btn-warning');
        }

        document.getElementById('tipoPago').value = tipo;
    }

    // ========== AGREGAR PRODUCTO CON CONTROL DE STOCK ==========
    function agregarDetalle() {
        const productoSelect = document.getElementById('productoId');
        const cantidad = parseInt(document.getElementById('cantidad').value);

        if (!productoSelect.value || cantidad <= 0) {
            alert('‚ö†Ô∏è Seleccione un producto y una cantidad v√°lida');
            return;
        }

        const productoId = productoSelect.value;
        const productoText = productoSelect.options[productoSelect.selectedIndex].text;
        const stockReal = parseInt(productoSelect.options[productoSelect.selectedIndex].getAttribute('data-stock'));

        const cantidadYaAgregada = productosAgregados[productoId] || 0;
        const stockDisponible = stockReal - cantidadYaAgregada;

        if (cantidad > stockDisponible) {
            alert(`‚ö†Ô∏è Stock insuficiente!\n\nStock real: ${stockReal} unidades\nYa agregaste: ${cantidadYaAgregada} unidades\nDisponible: ${stockDisponible} unidades\nSolicitado: ${cantidad} unidades`);
            return;
        }

        const precio = parseFloat(document.getElementById('precio').value);

        if (!precio || precio <= 0) {
            alert('‚ö†Ô∏è El precio debe ser mayor a 0');
            return;
        }

        const subtotal = cantidad * precio;
        productosAgregados[productoId] = cantidadYaAgregada + cantidad;

        document.getElementById('mensajeVacio').style.display = 'none';

        const tabla = document.getElementById('detallesTabla');
        const fila = tabla.insertRow();

        fila.innerHTML = `
            <td>
                ${productoText}
                <input type="hidden" name="detalles[${detalleIndex}].idProducto" value="${productoId}">
            </td>
            <td>
                ${cantidad}
                <input type="hidden" name="detalles[${detalleIndex}].cantidad" value="${cantidad}">
            </td>
            <td>
                $${precio.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                <input type="hidden" name="detalles[${detalleIndex}].precioUnitario" value="${precio}">
            </td>
            <td>$${subtotal.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarDetalle(this, '${productoId}', ${cantidad})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

        detalleIndex++;
        calcularTotal();
        limpiarCampos();
        actualizarStockMostrado();
    }

    function eliminarDetalle(btn, productoId, cantidad) {
        productosAgregados[productoId] -= cantidad;
        if (productosAgregados[productoId] <= 0) {
            delete productosAgregados[productoId];
        }

        btn.closest('tr').remove();
        calcularTotal();
        actualizarStockMostrado();

        const tabla = document.getElementById('detallesTabla');
        if (tabla.rows.length === 0) {
            document.getElementById('mensajeVacio').style.display = 'block';
        }
    }

    function calcularTotal() {
        const filas = document.querySelectorAll('#detallesTabla tr');
        let total = 0;

        filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            if (celdas.length > 0) {
                const subtotalText = celdas[3].textContent.replace('$', '').replace(/\./g, '').replace(',', '.');
                total += parseFloat(subtotalText);
            }
        });

        document.getElementById('totalVentaDisplay').value = total.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('totalHidden').value = total.toFixed(2);
    }

    function limpiarCampos() {
        document.getElementById('productoId').value = '';
        document.getElementById('cantidad').value = '1';
        document.getElementById('precio').value = '';
        document.getElementById('stockDisponible').textContent = '-';
    }

    function actualizarStockMostrado() {
        const productoSelect = document.getElementById('productoId');
        if (productoSelect.value) {
            const productoId = productoSelect.value;
            const stockReal = parseInt(productoSelect.options[productoSelect.selectedIndex].getAttribute('data-stock'));
            const cantidadAgregada = productosAgregados[productoId] || 0;
            const stockDisponible = stockReal - cantidadAgregada;

            if (cantidadAgregada > 0) {
                document.getElementById('stockDisponible').textContent = `${stockDisponible} unidades (${cantidadAgregada} ya agregadas)`;
            } else {
                document.getElementById('stockDisponible').textContent = `${stockDisponible} unidades`;
            }

            const stockElement = document.getElementById('stockDisponible').parentElement;
            if (stockDisponible === 0) {
                stockElement.className = 'alert alert-danger mb-0';
            } else if (stockDisponible < 10) {
                stockElement.className = 'alert alert-warning mb-0';
            } else {
                stockElement.className = 'alert alert-info mb-0';
            }
        }
    }

    function actualizarPrecio() {
        const productoSelect = document.getElementById('productoId');
        const precioInput = document.getElementById('precio');

        if (productoSelect.value) {
            const precio = productoSelect.options[productoSelect.selectedIndex].getAttribute('data-precio');
            precioInput.value = parseFloat(precio).toFixed(2);
            actualizarStockMostrado();
        } else {
            precioInput.value = '';
            document.getElementById('stockDisponible').textContent = '-';
            document.getElementById('stockDisponible').parentElement.className = 'alert alert-info mb-0';
        }
    }

    function validarFormulario() {
        const tabla = document.getElementById('detallesTabla');
        const tipoPago = document.getElementById('tipoPago').value;
        const cedula = document.getElementById('cedula').value;

        if (!cedula) {
            alert('‚ö†Ô∏è Debe seleccionar un cliente');
            return false;
        }

        if (!tipoPago) {
            alert('‚ö†Ô∏è Debe seleccionar un tipo de pago');
            return false;
        }

        if (tabla.rows.length === 0) {
            alert('‚ö†Ô∏è Debe agregar al menos un producto a la venta');
            return false;
        }

        return true;
    }
</script>
</body>
</html>